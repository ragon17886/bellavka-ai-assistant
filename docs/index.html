<!DOCTYPE html>
<html>
<head>
    <title>Bellavka Admin - Database Debug</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        .nav { background: #2c3e50; padding: 15px; border-radius: 6px; }
        .nav button { background: #3498db; color: white; border: none; padding: 10px 15px; margin: 0 5px; border-radius: 4px; cursor: pointer; }
        .nav button:hover { background: #2980b9; }
        .data-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; }
        pre { background: #2c3e50; color: white; padding: 15px; border-radius: 4px; overflow: auto; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .debug { background: #fff3cd; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Bellavka Admin - Debug Mode</h1>
        
        <div class="section debug">
            <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API Endpoints</h3>
            <button onclick="testEndpoint('/api/admin/assistants')">Test /assistants</button>
            <button onclick="testEndpoint('/api/admin/dialogs')">Test /dialogs</button>
            <button onclick="testEndpoint('/api/admin/stats')">Test /stats</button>
            <button onclick="testEndpoint('/api/admin/direct-query')">Test /direct-query</button>
            <div id="endpoint-test"></div>
        </div>

        <div class="nav">
            <button onclick="loadTable('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button onclick="loadTable('dialogs')">üí¨ –î–∏–∞–ª–æ–≥–∏</button>
            <button onclick="loadTable('assistants')">ü§ñ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã</button>
            <button onclick="runCustomQuery()">üîß –ü—Ä—è–º–æ–π SQL</button>
        </div>

        <div class="section">
            <h3>üìä –î–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã:</h3>
            <div id="data-result">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://bellavka-ai-assistant-worker.ragon17886.workers.dev';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è endpoints
        async function testEndpoint(endpoint) {
            try {
                const response = await fetch(WORKER_URL + endpoint);
                const text = await response.text();
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    data = { raw: text };
                }
                
                document.getElementById('endpoint-test').innerHTML = `
                    <div class="data-section">
                        <strong>${endpoint}:</strong> Status ${response.status}
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('endpoint-test').innerHTML = `
                    <div class="error">
                        <strong>${endpoint} ERROR:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function loadTable(tableName) {
            try {
                showLoading(`–ó–∞–≥—Ä—É–∑–∫–∞ ${tableName}...`);
                
                const response = await fetch(`${WORKER_URL}/api/admin/direct-query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: `SELECT * FROM ${tableName} LIMIT 20`
                    })
                });
                
                const text = await response.text();
                let result;
                
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    showError(`–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: ${text}`);
                    return;
                }
                
                if (result.success && result.data) {
                    showData(tableName, result.data);
                } else {
                    showError(`–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
                
            } catch (error) {
                showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
            }
        }

        async function runCustomQuery() {
            const query = prompt('–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å:', 'SELECT name FROM sqlite_master WHERE type="table"');
            if (!query) return;
            
            try {
                showLoading(`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...`);
                
                const response = await fetch(`${WORKER_URL}/api/admin/direct-query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });
                
                const text = await response.text();
                let result;
                
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    showError(`–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: ${text}`);
                    return;
                }
                
                if (result.success) {
                    showData('–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞', result.data);
                } else {
                    showError(`–û—à–∏–±–∫–∞: ${result.error}`);
                }
                
            } catch (error) {
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        function showLoading(message) {
            document.getElementById('data-result').innerHTML = `<p>‚è≥ ${message}</p>`;
        }

        function showData(title, data) {
            const count = Array.isArray(data) ? data.length : 0;
            document.getElementById('data-result').innerHTML = `
                <div class="data-section">
                    <h4>${title} (${count} –∑–∞–ø–∏—Å–µ–π)</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('data-result').innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        // –ê–≤—Ç–æ-—Ç–µ—Å—Ç endpoints –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        testEndpoint('/api/admin/assistants');
    </script>
</body>
</html>